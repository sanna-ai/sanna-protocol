{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://sanna.dev/schemas/constitution/v0.1.json",
  "title": "Sanna Constitution",
  "description": "Schema for Sanna constitution files — agent governance documents",
  "type": "object",
  "required": ["identity", "provenance", "boundaries"],
  "properties": {
    "sanna_constitution": {
      "type": "string",
      "description": "Schema version of this constitution document",
      "examples": ["1.0.0", "0.1.0"]
    },
    "identity": {
      "type": "object",
      "required": ["agent_name", "domain"],
      "properties": {
        "agent_name": {
          "type": "string",
          "description": "Unique name for the agent",
          "minLength": 1
        },
        "domain": {
          "type": "string",
          "description": "Business domain (e.g., 'customer-service', 'finance')",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "description": "Optional description of what this agent does"
        },
        "identity_claims": {
          "type": "array",
          "description": "Verifiable identity claims from external providers",
          "items": {
            "type": "object",
            "properties": {
              "provider": {"type": "string", "description": "Identity provider (e.g., 'trulioo', 'internal')"},
              "claim_type": {"type": "string", "description": "Type of identity claim"},
              "credential_id": {"type": "string", "description": "External credential reference"},
              "issued_at": {"type": "string", "description": "ISO 8601 timestamp of issuance"},
              "expires_at": {"type": "string", "description": "ISO 8601 timestamp of expiry"},
              "signature": {"type": "string", "description": "Base64-encoded Ed25519 signature from provider"},
              "public_key_id": {"type": "string", "description": "Key ID for the provider's signing key"}
            },
            "required": ["provider", "claim_type", "credential_id", "issued_at"],
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "provenance": {
      "type": "object",
      "required": ["authored_by", "approved_by", "approval_date", "approval_method"],
      "properties": {
        "authored_by": {
          "type": "string",
          "description": "Email of the constitution author",
          "minLength": 1
        },
        "approved_by": {
          "oneOf": [
            {
              "type": "array",
              "items": {"type": "string"},
              "minItems": 1
            },
            {
              "type": "string",
              "minLength": 1
            }
          ],
          "description": "Email(s) of constitution approver(s)"
        },
        "approval_date": {
          "type": "string",
          "description": "ISO 8601 date when the constitution was approved",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}"
        },
        "approval_method": {
          "type": "string",
          "description": "How approval was obtained",
          "minLength": 1
        },
        "change_history": {
          "type": "array",
          "items": {"type": "object"},
          "description": "Version history"
        },
        "signature": {
          "type": ["object", "null"],
          "description": "Ed25519 signature block (set by sanna-sign-constitution with --private-key)",
          "properties": {
            "value": {
              "type": ["string", "null"],
              "description": "Base64-encoded Ed25519 signature of the full document"
            },
            "key_id": {
              "type": ["string", "null"],
              "description": "Full SHA-256 fingerprint of the signing public key (64 hex chars)",
              "pattern": "^[a-f0-9]{64}$"
            },
            "signed_by": {
              "type": ["string", "null"],
              "description": "Identity of the signer"
            },
            "signed_at": {
              "type": ["string", "null"],
              "description": "ISO 8601 timestamp when the constitution was signed"
            },
            "scheme": {
              "type": "string",
              "description": "Signature scheme identifier",
              "enum": ["constitution_sig_v1"]
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "boundaries": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/Boundary"
      }
    },
    "trust_tiers": {
      "type": "object",
      "properties": {
        "autonomous": {
          "type": "array",
          "items": {"type": "string"}
        },
        "requires_approval": {
          "type": "array",
          "items": {"type": "string"}
        },
        "prohibited": {
          "type": "array",
          "items": {"type": "string"}
        }
      },
      "additionalProperties": false
    },
    "halt_conditions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/HaltCondition"
      }
    },
    "invariants": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Invariant"
      }
    },
    "authority_boundaries": {
      "type": "object",
      "description": "Authority boundary definitions — what the agent can, cannot, and must escalate",
      "properties": {
        "cannot_execute": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Actions the agent must never perform"
        },
        "must_escalate": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["condition"],
            "properties": {
              "condition": {
                "type": "string",
                "description": "Natural-language condition for when escalation is required",
                "minLength": 1
              },
              "target": {
                "type": "object",
                "properties": {
                  "type": {
                    "type": "string",
                    "enum": ["log", "webhook", "callback"],
                    "description": "Escalation target type"
                  },
                  "url": {
                    "type": "string",
                    "description": "Webhook URL (for type=webhook)"
                  },
                  "handler": {
                    "type": "string",
                    "description": "Registered callback name (for type=callback)"
                  }
                },
                "additionalProperties": false
              }
            },
            "additionalProperties": false
          },
          "description": "Conditions requiring human/system review before proceeding"
        },
        "can_execute": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Actions explicitly permitted for the agent"
        }
      },
      "additionalProperties": false
    },
    "escalation_targets": {
      "type": "object",
      "description": "Global escalation target configuration",
      "properties": {
        "default": {
          "type": "string",
          "enum": ["log", "webhook", "callback"],
          "description": "Default escalation target type when a rule has no explicit target"
        }
      },
      "additionalProperties": false
    },
    "trusted_sources": {
      "type": ["object", "null"],
      "description": "Source trust tiers for C1 source-aware context evaluation. Maps source names to trust levels.",
      "properties": {
        "tier_1": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Full trust — claims count as grounded evidence"
        },
        "tier_2": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Evidence with verification flag in receipt"
        },
        "tier_3": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Reference only — cannot be sole basis for conclusions"
        },
        "untrusted": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Excluded from C1 contradiction checking"
        }
      },
      "additionalProperties": false
    },
    "policy_hash": {
      "type": ["string", "null"],
      "description": "SHA-256 hash of canonical constitution content (set by sanna-sign-constitution or sanna-hash-constitution)",
      "pattern": "^[a-f0-9]{64}$"
    },
    "approval": {
      "type": ["object", "null"],
      "description": "Approval chain — cryptographic approval binding (v0.9.0+)",
      "properties": {
        "records": {
          "type": "array",
          "description": "List of approval records (v0.9.0 uses single record)",
          "items": {
            "$ref": "#/$defs/ApprovalRecord"
          }
        }
      },
      "required": ["records"],
      "additionalProperties": false
    }
  },
  "additionalProperties": false,
  "$defs": {
    "Boundary": {
      "type": "object",
      "required": ["id", "description", "category", "severity"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Boundary ID (B### pattern)",
          "pattern": "^B\\d{3}$"
        },
        "description": {
          "type": "string",
          "minLength": 1
        },
        "category": {
          "type": "string",
          "enum": ["scope", "authorization", "confidentiality", "safety", "compliance", "custom"]
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low", "info"]
        }
      },
      "additionalProperties": false
    },
    "HaltCondition": {
      "type": "object",
      "required": ["id", "trigger", "escalate_to", "severity", "enforcement"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Halt condition ID (H### pattern)",
          "pattern": "^H\\d{3}$"
        },
        "trigger": {
          "type": "string",
          "minLength": 1
        },
        "escalate_to": {
          "type": "string",
          "minLength": 1
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low", "info"]
        },
        "enforcement": {
          "type": "string",
          "enum": ["halt", "warn", "log"]
        }
      },
      "additionalProperties": false
    },
    "Invariant": {
      "type": "object",
      "required": ["id", "rule", "enforcement"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Invariant ID (INV_* for standard, INV_CUSTOM_* for custom)",
          "minLength": 1
        },
        "rule": {
          "type": "string",
          "description": "Human-readable description of the invariant",
          "minLength": 1
        },
        "enforcement": {
          "type": "string",
          "enum": ["halt", "warn", "log"]
        },
        "check": {
          "type": ["string", "null"],
          "description": "Optional check implementation ID (e.g., 'sanna.context_contradiction')"
        }
      },
      "additionalProperties": false
    },
    "ApprovalRecord": {
      "type": "object",
      "description": "A single approval record binding an approver to a constitution version",
      "required": ["status", "approver_id", "approver_role", "approved_at", "approval_signature", "constitution_version", "content_hash"],
      "properties": {
        "status": {
          "type": "string",
          "description": "Approval status",
          "enum": ["approved", "pending", "revoked"]
        },
        "approver_id": {
          "type": "string",
          "description": "Email or identifier of the approver",
          "minLength": 1
        },
        "approver_role": {
          "type": "string",
          "description": "Human-readable role of the approver (e.g., 'VP Risk', 'CISO')",
          "minLength": 1
        },
        "approved_at": {
          "type": "string",
          "description": "ISO 8601 timestamp when the approval was granted"
        },
        "approval_signature": {
          "type": "string",
          "description": "Base64-encoded Ed25519 signature of the approval record"
        },
        "constitution_version": {
          "type": "string",
          "description": "Human-readable version (e.g., '1', '2.0', '3.1-rc1')",
          "minLength": 1
        },
        "content_hash": {
          "type": "string",
          "description": "SHA-256 hash of constitution content at approval time",
          "pattern": "^[a-f0-9]{64}$"
        },
        "previous_version_hash": {
          "type": ["string", "null"],
          "description": "Content hash of the prior version (links versions together)",
          "pattern": "^[a-f0-9]{64}$"
        }
      },
      "additionalProperties": false
    }
  }
}
